<div class="user-form-container py-4">
  <div *ngIf="loading" class="loading-container">
    <app-loading-spinner></app-loading-spinner>
  </div>

  <div *ngIf="!loading" class="form-content">
    <div class="d-flex justify-content-start mb-4">
      <app-unified-button variant="secondary" [outlined]="true" (clicked)="router.navigate(['/users'])">
        <app-icon name="arrow-left" customClass="me-2"></app-icon>
        Back to Users
      </app-unified-button>
    </div>

    <app-unified-card>
      <div class="form-section">
        <h3 class="form-section-title">
          <app-icon name="user-plus" customClass="section-icon"></app-icon>
          {{ isEditMode ? 'Edit User Information' : 'Create New User' }}
        </h3>
        <p class="form-section-description">
          {{ isEditMode ? 'Update user details and basic information.' : 'Fill in the details to create a new user account.' }}
        </p>
      </div>

      <div class="form-grid">
        <!-- Basic Information -->
        <div class="form-section">
          <h4 class="subsection-title">
            <app-icon name="user" customClass="subsection-icon"></app-icon>
            Basic Information
          </h4>

          <div class="form-row">
            <div class="form-group half-width">
              <app-form-field
                label="First Name"
                icon="user"
                [required]="true">
                <input
                  type="text"
                  [(ngModel)]="formData.firstName"
                  placeholder="Enter first name"
                  class="form-control"
                  [disabled]="saving"
                />
              </app-form-field>
            </div>

            <div class="form-group half-width">
              <app-form-field
                label="Last Name"
                icon="user"
                [required]="true">
                <input
                  type="text"
                  [(ngModel)]="formData.lastName"
                  placeholder="Enter last name"
                  class="form-control"
                  [disabled]="saving"
                />
              </app-form-field>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <app-form-field
                label="Phone Number"
                icon="phone">
                <input
                  type="tel"
                  [(ngModel)]="formData.phoneNumber"
                  placeholder="Enter phone number"
                  class="form-control"
                  [disabled]="saving"
                />
              </app-form-field>
            </div>

            <div class="form-group half-width" *ngIf="!isEditMode">
              <app-form-field
                label="Company ID"
                icon="building">
                <input
                  type="text"
                  [(ngModel)]="formData.companyId"
                  placeholder="Enter company ID (optional)"
                  class="form-control"
                  [disabled]="saving"
                />
              </app-form-field>
            </div>
          </div>
        </div>

        <!-- Account Information (Create Mode Only) -->
        <div class="form-section" *ngIf="!isEditMode">
          <h4 class="subsection-title">
            <app-icon name="shield" customClass="subsection-icon"></app-icon>
            Account Information
          </h4>

          <div class="form-row">
            <div class="form-group half-width">
              <app-form-field
                label="Email Address"
                icon="envelope"
                [required]="true">
                <input
                  type="email"
                  [(ngModel)]="formData.email"
                  placeholder="Enter email address"
                  class="form-control"
                  [disabled]="saving"
                />
              </app-form-field>
            </div>

            <div class="form-group half-width">
              <app-form-field
                label="Username"
                icon="at"
                [required]="true">
                <input
                  type="text"
                  [(ngModel)]="formData.userName"
                  placeholder="Enter username"
                  class="form-control"
                  [disabled]="saving"
                />
              </app-form-field>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <app-form-field
                label="Password"
                icon="lock"
                [required]="true">
                <input
                  type="password"
                  [(ngModel)]="formData.password"
                  placeholder="Enter password"
                  class="form-control"
                  [disabled]="saving"
                />
              </app-form-field>
            </div>

            <div class="form-group half-width">
              <app-form-field
                label="Confirm Password"
                icon="check-circle"
                [required]="true">
                <input
                  type="password"
                  [(ngModel)]="formData.confirmPassword"
                  placeholder="Confirm password"
                  class="form-control"
                  [disabled]="saving"
                />
              </app-form-field>
            </div>
          </div>
        </div>

        <!-- Read-only Account Information (Edit Mode) -->
        <div class="form-section" *ngIf="isEditMode && user">
          <h4 class="subsection-title">
            <app-icon name="shield" customClass="subsection-icon"></app-icon>
            Account Information
          </h4>

          <div class="form-row">
            <div class="form-group half-width">
              <app-form-field
                label="Email Address"
                icon="envelope">
                <input
                  type="email"
                  [value]="user.email"
                  disabled
                  class="form-control"
                />
                <small class="form-help">Email cannot be changed</small>
              </app-form-field>
            </div>

            <div class="form-group half-width">
              <app-form-field
                label="Username"
                icon="at">
                <input
                  type="text"
                  [value]="user.userName"
                  disabled
                  class="form-control"
                />
                <small class="form-help">Username cannot be changed</small>
              </app-form-field>
            </div>
          </div>
        </div>

        <!-- Roles -->
        <div class="form-section">
          <h4 class="subsection-title">
            <app-icon name="users" customClass="subsection-icon"></app-icon>
            Roles & Permissions
          </h4>
          <p class="form-section-description">Select the roles to assign to this user.</p>

          <div class="roles-grid">
            <div *ngFor="let role of availableRoles" class="role-checkbox">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="isRoleSelected(role.name)"
                  (change)="onRoleChange(role.name, $any($event.target).checked)"
                  [disabled]="saving || (isEditMode && !permissionService.hasPermission('Users:Update'))"
                />
                <span class="checkmark"></span>
                <span class="role-name">{{ role.name }}</span>
                <small class="role-description" *ngIf="role.description">{{ role.description }}</small>
              </label>
            </div>
          </div>

          <div *ngIf="!isEditMode" class="form-help">
            <app-icon name="info-circle" customClass="help-icon"></app-icon>
            At least one role must be selected to create a user.
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <app-unified-button
          variant="secondary"
          [outlined]="true"
          (clicked)="router.navigate(['/users'])"
          [disabled]="saving">
          <app-icon name="times" customClass="me-2"></app-icon>
          Cancel
        </app-unified-button>

        <app-unified-button
          variant="primary"
          (clicked)="save()"
          [disabled]="saving">
          <app-icon *ngIf="saving" name="spinner" customClass="loading-icon spinning me-2"></app-icon>
          <app-icon *ngIf="!saving" name="save" customClass="me-2"></app-icon>
          {{ saving ? (isEditMode ? 'Updating...' : 'Creating...') : (isEditMode ? 'Update User' : 'Create User') }}
        </app-unified-button>
      </div>
    </app-unified-card>
  </div>

  <app-toast
    *ngIf="showToast"
    [message]="toastMessage"
    [type]="toastType"
    (close)="showToast = false">
  </app-toast>
</div>