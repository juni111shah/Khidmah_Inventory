<div class="user-profile-container py-4">
  <div *ngIf="loading" class="loading-container">
    <app-loading-spinner></app-loading-spinner>
  </div>

  <div *ngIf="!loading && user" class="profile-content">
    <div class="d-flex justify-content-start mb-4">
      <app-unified-button variant="secondary" [outlined]="true" (clicked)="router.navigate(['/users'])">
        <app-icon name="arrow-left" customClass="me-2"></app-icon>
        Back to Users
      </app-unified-button>
    </div>

    <div class="profile-header">
      <div class="avatar-large">
        <app-icon name="user" customClass="avatar-icon"></app-icon>
        <span class="avatar-initials">{{ user.firstName[0] }}{{ user.lastName[0] }}</span>
      </div>
      <div class="user-info">
        <h2>{{ user.firstName }} {{ user.lastName }}</h2>
        <p class="email">
          <app-icon name="envelope" customClass="email-icon"></app-icon>
          {{ user.email }}
        </p>
        <div class="meta">
          <span class="badge" [class.active]="user.isActive" [class.inactive]="!user.isActive">
            <app-icon name="circle-fill" customClass="status-icon"></app-icon>
            {{ user.isActive ? 'Active' : 'Inactive' }}
          </span>
          <span *ngIf="user.roles.length > 0" class="roles">
            <span *ngFor="let role of user.roles" class="role-badge">
              <app-icon name="shield-check" customClass="role-icon"></app-icon>
              {{ role }}
            </span>
          </span>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button
        *appHasPermission="'Users:Read'"
        [class.active]="activeTab === 'profile'"
        (click)="activeTab = 'profile'"
        class="tab-btn"
      >
        <app-icon name="user" customClass="tab-icon"></app-icon>
        Profile Information
      </button>
      <button
        *appHasPermission="'Users:Update'"
        [class.active]="activeTab === 'password'"
        (click)="activeTab = 'password'"
        class="tab-btn"
      >
        <app-icon name="lock" customClass="tab-icon"></app-icon>
        Change Password
      </button>
    </div>

    <div class="tab-content">
      <!-- Profile Tab -->
      <div *ngIf="activeTab === 'profile'" class="profile-form">
        <div class="form-section">
          <h3 class="form-section-title">
            <app-icon name="user-edit" customClass="section-icon"></app-icon>
            Personal Information
          </h3>
          <p class="form-section-description">Update your personal details and contact information.</p>
        </div>

        <div class="form-row">
          <div class="form-group half-width">
            <label>
              <app-icon name="user" customClass="field-icon"></app-icon>
              First Name <span class="required">*</span>
            </label>
            <input
              type="text"
              [(ngModel)]="profileForm.firstName"
              placeholder="Enter first name"
              class="form-control"
            />
          </div>

          <div class="form-group half-width">
            <label>
              <app-icon name="user" customClass="field-icon"></app-icon>
              Last Name <span class="required">*</span>
            </label>
            <input
              type="text"
              [(ngModel)]="profileForm.lastName"
              placeholder="Enter last name"
              class="form-control"
            />
          </div>
        </div>

        <div class="form-group">
          <label>
            <app-icon name="envelope" customClass="field-icon"></app-icon>
            Email Address
          </label>
          <input
            type="email"
            [value]="user.email"
            disabled
            class="form-control"
          />
          <small class="form-help">Email cannot be changed. Contact administrator if needed.</small>
        </div>

        <div class="form-group">
          <label>
            <app-icon name="at" customClass="field-icon"></app-icon>
            Username
          </label>
          <input
            type="text"
            [value]="user.userName"
            disabled
            class="form-control"
          />
          <small class="form-help">Username is used for login and cannot be changed.</small>
        </div>

        <div class="form-group">
          <label>
            <app-icon name="phone" customClass="field-icon"></app-icon>
            Phone Number
          </label>
          <input
            type="tel"
            [(ngModel)]="profileForm.phoneNumber"
            placeholder="Enter phone number"
            class="form-control"
          />
        </div>

        <div class="form-actions">
          <button
            *appHasPermission="'Users:Update'"
            (click)="saveProfile()"
            [disabled]="saving"
            class="btn btn-primary"
          >
            <app-icon *ngIf="saving" name="spinner" customClass="loading-icon spinning"></app-icon>
            <app-icon *ngIf="!saving" name="save" customClass="btn-icon"></app-icon>
            <span>{{ saving ? 'Saving Changes...' : 'Save Changes' }}</span>
          </button>
        </div>
      </div>

      <!-- Password Tab -->
      <div *ngIf="activeTab === 'password'" class="password-form">
        <div class="form-section">
          <h3 class="form-section-title">
            <app-icon name="shield" customClass="section-icon"></app-icon>
            Security Settings
          </h3>
          <p class="form-section-description">Change your password to keep your account secure.</p>
        </div>

        <div class="form-group">
          <label>
            <app-icon name="lock" customClass="field-icon"></app-icon>
            Current Password <span class="required">*</span>
          </label>
          <div class="input-group">
            <input
              type="password"
              [(ngModel)]="passwordForm.currentPassword"
              placeholder="Enter current password"
              class="form-control"
            />
            <div class="input-group-text">
              <app-icon name="eye" customClass="password-toggle-icon"></app-icon>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>
            <app-icon name="key" customClass="field-icon"></app-icon>
            New Password <span class="required">*</span>
          </label>
          <div class="input-group">
            <input
              type="password"
              [(ngModel)]="passwordForm.newPassword"
              placeholder="Enter new password"
              class="form-control"
            />
            <div class="input-group-text">
              <app-icon name="eye" customClass="password-toggle-icon"></app-icon>
            </div>
          </div>
          <small class="form-help">Password must be at least 6 characters long.</small>
        </div>

        <div class="form-group">
          <label>
            <app-icon name="check-circle" customClass="field-icon"></app-icon>
            Confirm New Password <span class="required">*</span>
          </label>
          <div class="input-group">
            <input
              type="password"
              [(ngModel)]="confirmPassword"
              placeholder="Confirm new password"
              class="form-control"
            />
            <div class="input-group-text">
              <app-icon name="eye" customClass="password-toggle-icon"></app-icon>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button
            *appHasPermission="'Users:Update'"
            (click)="changePassword()"
            [disabled]="changingPassword"
            class="btn btn-primary"
          >
            <app-icon *ngIf="changingPassword" name="spinner" customClass="loading-icon spinning"></app-icon>
            <app-icon *ngIf="!changingPassword" name="lock" customClass="btn-icon"></app-icon>
            <span>{{ changingPassword ? 'Changing Password...' : 'Change Password' }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <app-toast
    *ngIf="showToast"
    [message]="toastMessage"
    [type]="toastType"
    (close)="showToast = false"
  ></app-toast>
</div>

