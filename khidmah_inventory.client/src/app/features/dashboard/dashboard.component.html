<div class="dashboard-container container-fluid py-4">
  <app-content-loader [loading]="loading">
    <ng-container skeleton>
      <!-- Quick actions -->
      <div class="d-flex flex-wrap gap-2 mb-3">
        <app-skeleton-loader *ngFor="let i of skeletonQuickActionCount" [width]="'100px'" [height]="'36px'" shape="rounded" [animation]="'shimmer'"></app-skeleton-loader>
      </div>
      <!-- Stat cards: match real layout (col-6 col-md-3) -->
      <app-skeleton-stat-cards [cardCount]="4" class="mb-4"></app-skeleton-stat-cards>
      <!-- Analyze → Predict → Act: one card, 3 columns -->
      <div class="row g-3 mb-4">
        <div class="col-12">
          <div class="rounded-3 border-0 shadow-sm p-4 bg-white">
            <app-skeleton-loader [width]="'200px'" [height]="'14px'" shape="rounded" [animation]="'shimmer'" class="mb-3"></app-skeleton-loader>
            <div class="row g-3">
              <div class="col-md-4"><app-skeleton-loader [width]="'100%'" [height]="'48px'" shape="rounded" [animation]="'shimmer'" class="mb-2"></app-skeleton-loader><app-skeleton-loader [width]="'80%'" [height]="'32px'" shape="rounded" [animation]="'shimmer'"></app-skeleton-loader></div>
              <div class="col-md-4"><app-skeleton-loader [width]="'100%'" [height]="'48px'" shape="rounded" [animation]="'shimmer'" class="mb-2"></app-skeleton-loader><app-skeleton-loader [width]="'70%'" [height]="'32px'" shape="rounded" [animation]="'shimmer'"></app-skeleton-loader></div>
              <div class="col-md-4"><app-skeleton-loader [width]="'100%'" [height]="'48px'" shape="rounded" [animation]="'shimmer'" class="mb-2"></app-skeleton-loader><app-skeleton-loader [width]="'60%'" [height]="'32px'" shape="rounded" [animation]="'shimmer'"></app-skeleton-loader></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Decision support teaser: icon + title + description + button -->
      <div class="row g-3 mb-4">
        <div class="col-12">
          <div class="rounded-3 border-0 shadow-sm p-4 bg-white d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
              <app-skeleton-loader [width]="'48px'" [height]="'48px'" shape="circle" [animation]="'shimmer'"></app-skeleton-loader>
              <div>
                <app-skeleton-loader [width]="'220px'" [height]="'18px'" shape="rounded" [animation]="'shimmer'" class="mb-2"></app-skeleton-loader>
                <app-skeleton-loader [width]="'280px'" [height]="'14px'" shape="rounded" [animation]="'shimmer'"></app-skeleton-loader>
              </div>
            </div>
            <app-skeleton-loader [width]="'80px'" [height]="'32px'" shape="rounded" [animation]="'shimmer'"></app-skeleton-loader>
          </div>
        </div>
      </div>
      <!-- Charts row 1 -->
      <div class="row g-3 mb-3">
        <div class="col-lg-7"><app-skeleton-chart [chartHeight]="280" class="h-100"></app-skeleton-chart></div>
        <div class="col-lg-5"><app-skeleton-chart [chartHeight]="280" [showSubtitle]="true"></app-skeleton-chart></div>
      </div>
      <!-- Chart row 2 -->
      <div class="row g-4 mb-4">
        <div class="col-12"><app-skeleton-chart [titleWidth]="'220px'" [chartHeight]="350"></app-skeleton-chart></div>
      </div>
      <!-- Three list cards -->
      <div class="row g-4">
        <div class="col-lg-4"><app-unified-card header="" customClass="h-100 border-0 shadow-sm"><app-skeleton-list [itemCount]="4" [showAvatar]="true"></app-skeleton-list></app-unified-card></div>
        <div class="col-lg-4"><app-unified-card header="" customClass="h-100 border-0 shadow-sm"><app-skeleton-list [itemCount]="4" [showAvatar]="true"></app-skeleton-list></app-unified-card></div>
        <div class="col-lg-4"><app-unified-card header="" customClass="h-100 border-0 shadow-sm"><app-skeleton-list [itemCount]="4" [showAvatar]="true"></app-skeleton-list></app-unified-card></div>
      </div>
    </ng-container>
    <div *ngIf="dashboard" class="dashboard-content">
    <!-- Quick actions: compact bar (no greeting card) -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <ng-container *ngFor="let action of quickActions">
        <a *appHasPermission="action.permission"
           [routerLink]="action.route"
           class="btn btn-sm btn-outline-primary rounded-pill d-inline-flex align-items-center gap-2">
          <i class="bi" [ngClass]="action.icon"></i>
          <span>{{ action.label }}</span>
        </a>
      </ng-container>
    </div>

    <!-- Summary Cards Grid (reusable KPI stat cards) -->
    <div class="row g-3 mb-4 equal-height-cards">
      <div class="col-6 col-md-3">
        <app-kpi-stat-card
          title="Products"
          [value]="formatNumber(dashboard.summary.totalProducts)"
          icon="bi-box-seam"
          theme="primary"
          [trendData]="totalProductsTrend"
          [trendPercent]="(getChangePercentage(totalProductsTrend) >= 0 ? '+' : '') + (Math.abs(getChangePercentage(totalProductsTrend)) | number:'1.0-0') + '%'">
        </app-kpi-stat-card>
      </div>
      <div class="col-6 col-md-3">
        <app-kpi-stat-card
          title="Warehouses"
          [value]="formatNumber(dashboard.summary.totalWarehouses)"
          icon="bi-building"
          theme="info"
          [trendData]="warehousesTrend"
          [trendPercent]="'+' + (Math.abs(getChangePercentage(warehousesTrend)) | number:'1.0-0') + '%'">
        </app-kpi-stat-card>
      </div>
      <div class="col-6 col-md-3">
        <app-kpi-stat-card
          title="Stock Value"
          [value]="formatCurrencyValue(dashboard.summary.totalStockValue)"
          icon="bi-currency-dollar"
          theme="success"
          [trendData]="stockValueTrend"
          [trendPercent]="(getChangePercentage(stockValueTrend) >= 0 ? '+' : '') + (Math.abs(getChangePercentage(stockValueTrend)) | number:'1.0-0') + '%'">
        </app-kpi-stat-card>
      </div>
      <div class="col-6 col-md-3">
        <app-kpi-stat-card
          title="Low Stock"
          [value]="formatNumber(dashboard.summary.lowStockItems)"
          icon="bi-exclamation-triangle"
          theme="danger"
          [trendData]="lowStockTrend"
          [trendPercent]="(getChangePercentage(lowStockTrend) < 0 ? '+' : '-') + (Math.abs(getChangePercentage(lowStockTrend)) | number:'1.0-0') + '%'">
        </app-kpi-stat-card>
      </div>
    </div>

    <!-- Intelligence: Predictions, Anomalies, Risks, Opportunities (content from API or fallback from dashboard summary) -->
    <div class="row g-3 mb-4" *ngIf="dashboard && !loadingIntelligence">
      <div class="col-12">
        <app-unified-card header="Analyze → Predict → Act" customClass="border-0 shadow-sm">
          <div class="row g-3">
            <div class="col-md-6 col-lg-3" *ngIf="analyzePredictActContent.predictions?.length">
              <h6 class="small text-uppercase text-muted mb-2">Predictions</h6>
              <div class="d-flex flex-column gap-2">
                <div *ngFor="let p of analyzePredictActContent.predictions" class="d-flex justify-content-between align-items-center p-2 rounded bg-light">
                  <span class="small">{{ p.label }}</span>
                  <strong>{{ p.value }}</strong>
                  <span class="badge" [ngClass]="p.trend === 'Up' ? 'bg-success' : p.trend === 'Down' ? 'bg-danger' : 'bg-secondary'">{{ p.trend }}</span>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3" *ngIf="analyzePredictActContent.anomalies?.length">
              <h6 class="small text-uppercase text-muted mb-2">Anomalies</h6>
              <div class="d-flex flex-column gap-2">
                <div *ngFor="let a of analyzePredictActContent.anomalies" class="p-2 rounded border-start border-3 border-warning">
                  <div class="small fw-bold">{{ a.metric }}</div>
                  <div class="small text-muted">{{ a.description }}</div>
                  <a *ngIf="a.drillDownRoute" [routerLink]="a.drillDownRoute" class="small">Drill down</a>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3" *ngIf="analyzePredictActContent.risks?.length">
              <h6 class="small text-uppercase text-muted mb-2">Risks</h6>
              <div class="d-flex flex-column gap-2">
                <div *ngFor="let r of analyzePredictActContent.risks" class="p-2 rounded border-start border-3" [ngClass]="r.severity === 'High' ? 'border-danger' : 'border-warning'">
                  <div class="small fw-bold">{{ r.title }}</div>
                  <div class="small text-muted">{{ r.description }}</div>
                  <a *ngIf="r.actionRoute" [routerLink]="r.actionRoute" class="btn btn-sm btn-outline-primary mt-1">Act</a>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3" *ngIf="analyzePredictActContent.opportunities?.length">
              <h6 class="small text-uppercase text-muted mb-2">Opportunities</h6>
              <div class="d-flex flex-column gap-2">
                <div *ngFor="let o of analyzePredictActContent.opportunities" class="p-2 rounded bg-success bg-opacity-10">
                  <div class="small fw-bold">{{ o.title }}</div>
                  <div class="small text-muted">{{ o.description }}</div>
                  <a *ngIf="o.actionRoute" [routerLink]="o.actionRoute" class="btn btn-sm btn-success mt-1">View</a>
                </div>
              </div>
            </div>
          </div>
        </app-unified-card>
      </div>
    </div>

    <!-- Decision support teaser -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <app-unified-card [hoverable]="true" customClass="border-0 shadow-sm">
          <a routerLink="/intelligence/decisions" class="text-decoration-none text-dark d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
              <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                <i class="bi bi-lightbulb text-primary fs-4"></i>
              </div>
              <div>
                <h6 class="mb-0">Decision support &amp; optimization</h6>
                <p class="mb-0 small text-muted">Actionable intelligence, what-if simulator, business health score</p>
              </div>
            </div>
            <span class="btn btn-sm btn-outline-primary">View</span>
          </a>
        </app-unified-card>
      </div>
    </div>

    <!-- Charts Row 1 - Sales Performance & Stock Analysis -->
    <div class="row g-3 mb-3 equal-height-cards dashboard-chart-cards">
      <!-- Stats Card -->
      <div class="col-lg-7">
        <app-stat-card
          title="Sales Performance"
          [range]="getStatCardRange() + ' units'"
          [period]="getStatCardPeriod()"
          [barData]="statCardData"
          [chartHeight]="280"
          [selectedTimeFrame]="selectedTimeFrame"
          [showFullStats]="false"
          (timeFrameChange)="onTimeFrameChange($event)">
        </app-stat-card>
      </div>

      <!-- Unified Stock Analysis Chart -->
      <div class="col-lg-5">
        <app-unified-card customClass="h-100 border-0 shadow-sm futuristic-card overflow-hidden">
          <!-- Row 1: Title + buttons. Row 2: Subtitle only -->
          <div class="dashboard-chart-card-header">
            <div class="d-flex justify-content-between align-items-center gap-2 mb-1">
              <h3 class="stat-title mb-0">Stock Analysis</h3>
              <div class="futuristic-tabs d-flex p-1 rounded-pill stock-analysis-tabs">
                <button
                  class="flex-grow-1 border-0 rounded-pill transition-all py-2 px-3 small fw-bold"
                  [class.active]="selectedStockTab === 'warehouse'"
                  (click)="onStockTabChange('warehouse')">
                  Warehouses
                </button>
                <button
                  class="flex-grow-1 border-0 rounded-pill transition-all py-2 px-3 small fw-bold"
                  [class.active]="selectedStockTab === 'category'"
                  (click)="onStockTabChange('category')">
                  Categories
                </button>
              </div>
            </div>
            <p class="text-muted small mb-0">By warehouse or category</p>
          </div>

          <!-- Chart Container -->
          <div class="dashboard-chart-card-body">
            <div class="chart-container" style="height: 280px;">
              <app-chart
                *ngIf="unifiedStockChartData && unifiedStockChartData.datasets && unifiedStockChartData.datasets.length > 0"
                type="bar"
                [data]="unifiedStockChartData"
                [options]="barChartOptions"
                [height]="280"
              ></app-chart>
              <div *ngIf="!unifiedStockChartData || !unifiedStockChartData.datasets || unifiedStockChartData.datasets.length === 0" class="text-center py-4 text-muted">
                <i class="bi bi-bar-chart fs-1 d-block mb-2 opacity-25"></i>
                <p class="mb-0 small">Analyzing stock data...</p>
              </div>
            </div>
          </div>
        </app-unified-card>
      </div>
    </div>

    <!-- Charts Row 2 - Sales & Purchases Trend -->
    <div class="row g-4 mb-4">
      <div class="col-12">
        <app-unified-card customClass="border-0 shadow-sm futuristic-card">
          <div class="d-flex flex-wrap justify-content-between align-items-center p-4">
            <div>
              <h3 class="stat-title mb-1">{{ salesChartTitle }}</h3>
              <p class="stat-source mb-0 text-muted">Comparative analysis of revenue vs acquisition</p>
            </div>

            <div class="time-period-selector d-flex gap-2">
              <button *ngFor="let p of [7, 15, 30]"
                      class="period-btn btn btn-sm rounded-pill px-3"
                      [class.btn-primary]="selectedSalesPeriod === p"
                      [class.btn-outline-secondary]="selectedSalesPeriod !== p"
                      (click)="onSalesPeriodChange(p)">
                {{ p }}D
              </button>
            </div>
          </div>

          <div class="p-4 pt-0">
            <div class="chart-container" style="height: 350px;">
              <app-chart
                *ngIf="salesChartData && salesChartData.datasets && salesChartData.datasets.length > 0"
                type="area"
                [data]="salesChartData"
                [options]="chartOptions"
                [height]="350"
              ></app-chart>
            </div>
          </div>
        </app-unified-card>
      </div>
    </div>

    <!-- Dynamic Activity & Lists -->
    <div class="row g-4 equal-height-cards">
      <!-- High Performance Products -->
      <div class="col-lg-4">
        <app-unified-card header="Top Selling" customClass="h-100 border-0 shadow-sm futuristic-card">
          <div class="p-3">
            <div *ngFor="let product of dashboard.topProducts; let i = index" class="activity-item d-flex align-items-center mb-3 p-2 rounded-3 hover-bg-light transition-all">
              <div class="rank-badge me-3 text-primary fw-bold">#{{ i + 1 }}</div>
              <div class="flex-grow-1">
                <h6 class="mb-0 fw-bold text-truncate" style="max-width: 150px;">{{ product.productName }}</h6>
                <div class="progress mt-1" style="height: 4px;">
                  <div class="progress-bar bg-primary" [style.width.%]="80 - (i * 10)"></div>
                </div>
              </div>
              <div class="text-end ms-3">
                <span class="d-block fw-bold small text-success">{{ formatCurrency(product.totalSales) }}</span>
                <span class="text-muted smaller">{{ product.quantitySold }} units</span>
              </div>
            </div>
            <div *ngIf="dashboard.topProducts.length === 0" class="text-center py-5 text-muted opacity-50">
               <i class="bi bi-star fs-1 mb-2 d-block"></i>
               <p>No sales activity tracked yet</p>
            </div>
          </div>
        </app-unified-card>
      </div>

      <!-- Critical Stock Alert -->
      <div class="col-lg-4">
        <app-unified-card header="Inventory Alerts" customClass="h-100 border-0 shadow-sm futuristic-card">
          <div class="p-3">
            <div *ngFor="let product of dashboard.lowStockProducts" class="alert-item d-flex align-items-center mb-3 border-left-danger p-2 h-100">
              <div class="alert-indicator me-3">
                <div class="pulse-indicator pulse-danger"></div>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0 fw-bold">{{ product.productName }}</h6>
                <span class="text-muted smaller">{{ product.warehouseName }}</span>
              </div>
              <div class="text-end">
                <span class="badge rounded-pill bg-danger-light text-danger">{{ product.currentStock }} left</span>
              </div>
            </div>
            <div *ngIf="dashboard.lowStockProducts.length === 0" class="text-center py-5 text-success">
              <i class="bi bi-shield-check fs-1 mb-2 d-block"></i>
              <p>All warehouses optimized</p>
            </div>
          </div>
        </app-unified-card>
      </div>

      <!-- Live Order Feed -->
      <div class="col-lg-4">
        <app-unified-card header="Live Order Feed" customClass="h-100 border-0 shadow-sm futuristic-card">
          <div class="p-3">
            <div *ngFor="let order of dashboard.recentOrders"
                 class="order-feed-item d-flex align-items-center mb-3 p-2 border-bottom border-light cursor-pointer hover-translate-x"
                 (click)="navigateToOrder(order)">
              <div class="order-type-icon me-3 h6 mb-0" [ngClass]="order.type === 'Purchase' ? 'text-warning' : 'text-primary'">
                <i class="bi" [ngClass]="order.type === 'Purchase' ? 'bi-arrow-down-left-circle' : 'bi-arrow-up-right-circle'"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0 fw-bold">{{ order.orderNumber }}</h6>
                <span class="text-muted smaller">{{ order.type }} • 2 mins ago</span>
              </div>
              <div class="text-end">
                <span class="d-block fw-bold small">{{ formatCurrency(order.totalAmount) }}</span>
                <span class="badge small py-1" [class]="'bg-' + (order.status.toLowerCase() === 'completed' ? 'success' : 'warning')">{{ order.status }}</span>
              </div>
            </div>
            <div *ngIf="dashboard.recentOrders.length === 0" class="text-center py-5 text-muted">
              <p>Waiting for incoming orders...</p>
            </div>
          </div>
        </app-unified-card>
      </div>
    </div>
  </div>
  </app-content-loader>

  <app-toast
    *ngIf="showToast"
    [message]="toastMessage"
    [type]="toastType"
    (close)="showToast = false"
  ></app-toast>
</div>
